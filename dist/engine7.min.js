/**
 * engine7 
 * 
 * 
 * https://github.com/jindong5210/engine7
 * 
 * Copyright 2017, Jeffrey King
 * 
 * Licensed under MIT
 * 
 * Released on: March 29, 2017
 */
window.Engine7=function(){"use strict";function isNull(e){return null===e||""===e||void 0===e}function getArrayIndex(e,t){for(var n=0;n<e.length;n++)if(e[n]==t)return n;return-1}function encodeJSON(e){for(var t in e)e[t]=encodeURIComponent(e[t]);return e}function Engine7(){function Request(element){var req=this;this.id=null,this.url=null,this.params=null,this.method="GET",this.tpl=null,this.dom=null,this.context={},this.handleSuccess=function(e,t){if(!isNull(req.id)){var n=engine.events.afterInvoke[req.id];isNull(n)||n(e,t,req)}e.$context=req.context,isNull(req.tpl)||req.tpl.render(e,req.dom)},this.handleError=function(e,t,n){if(isNull(req.id)||isNull(engine.events.invokeError[req.id]))throw console.error(n),new Error("Error occurs when invoking request ["+req.url+"]");var r=engine.events.invokeError[req.id];isNull(r)||r(e,t,n,req)},this.invoke=function(){var urlTemplate=Template7.compile(req.url),url=urlTemplate(req.context),params={};if(!isNull(req.params)){var paramsTemplate=Template7.compile(req.params);params=paramsTemplate(req.context);try{params=eval("("+params+")")}catch(e){throw console.error(e),new Error("Can not parse params to JSON. ["+req.id+"].")}"GET"==req.method&&(params=encodeJSON(params))}var options={url:url,type:req.method,dataType:"json",data:params,success:req.handleSuccess,error:req.handleError};if(!isNull(req.id)){var beforeInvokeEventCB=engine.events.beforeInvoke[req.id];isNull(beforeInvokeEventCB)||beforeInvokeEventCB(options,req)}$.ajax(options).done(function(){engine.tasks--}),engine.tasks++},this.init=function(){var e=$(element).attr(ATTR_TPL_ID),t=$(element).attr(ATTR_METHOD),n=$(element).attr(ATTR_ID);if(!isNull(e)){if(req.tpl=engine.templates[e],isNull(req.tpl))throw new Error("Undefined template ["+e+"].");$(element).attr(ATTR_REF,e)}isNull(t)||(req.method=t),isNull(n)||(req.id=n),req.url=$(element).attr(ATTR_URL),req.params=$(element).attr(ATTR_PARAMS),req.dom=$(element)},this.init()}function Template(e){var t=this;this.id=null,this.src=null,this.render=function(e,n){var r=Template7.compile(t.src),i=engine.events.beforeRender[t.id];isNull(i)||i(e,t);var s=r(e),o=$(s);n.append(o);var a=engine.events.afterRender[t.id];isNull(a)||a(o,t);var l=o.filter("["+ATTR_URL+"]");l.each(function(){var t=new Request(this);t.context=e,t.invoke()}),1===engine.tasks&&0===l.length&&engine.completeCB()},this.init=function(){if(t.id=$(e).attr("id"),t.src=$(e).html(),isNull(t.id))throw new Error("ID is required on template.")},this.init()}function Form(e){var t=this,n=["text","hidden","password","checkbox","radio"];this.id=null,this.action=null,this.method="GET",this.elements=[],this.putElJSON=function(e,t,n){for(var r=t.split(/\./);r.length>1;){var i=r.shift();e[i]||(e[i]={}),e=e[i]}var s=r[r.length-1];if(e[s]){var o=[e[s]];o.push(n),e[s]=o}else e[s]=n},this.toJSON=function(){for(var e={},n=0;n<t.elements.length;n++){var r=t.elements[n],i=r.tagName,s=$(r).attr("type"),o=$(r).attr("name"),a=$(r).val();("INPUT"!==i||"checkbox"!==s&&"radio"!==s||$(r).is(":checked"))&&t.putElJSON(e,o,a)}return e},this.handleSuccess=function(e,n){var r=engine.events.submitBack[t.id];isNull(r)||r(e,n,t)},this.handleError=function(e,n,r){var i=engine.events.submitError[t.id];if(isNull(i))throw console.error(r),new Error("Error occurs when submit form ["+t.id+"]");i(e,n,r,t)},this.submit=function(){var n=t.toJSON(),r=engine.events.beforeSubmit[t.id];isNull(r)||r(n,t);var i={url:t.action,type:t.method,dataType:"json",data:n,success:t.handleSuccess,error:t.handleError};$.ajax(i).done(function(){$(e).find("input[type='submit']").removeAttr("disabled")})},this.init=function(){if(t.id=$(e).attr("id"),t.action=$(e).attr("action"),isNull(t.id))throw new Error("ID is required on data-ajax-form.");if(isNull(t.action))throw new Error("Action is required on data-ajax-form.");var r=$(e).attr("method");isNull(r)||(t.method=r),$(e).find("input,textarea,select").each(function(){var e=$(this).attr("name"),r=$(this).attr("type"),i=this.tagName;if(!isNull(e)){if("INPUT"===i&&getArrayIndex(n,r)<0)return!0;t.elements.push(this)}}),$(e).submit(function(){return $(e).find("input[type='submit']").attr("disabled","disabled"),t.submit(),!1})},this.init()}var engine=this,ATTR_TEMPLATE7="text/template7",ATTR_ID="id",ATTR_TPL_ID="data-tpl-id",ATTR_URL="data-api-url",ATTR_METHOD="data-api-method",ATTR_PARAMS="data-api-param",ATTR_REF="data-tpl-ref",ATTR_AJAX_FORM="data-ajax-form";this.requests=[],this.templates={},this.forms={},this.tasks=0,this.completeCB=null,this.events={beforeInvoke:{},afterInvoke:{},beforeRender:{},afterRender:{},invokeError:{},beforeSubmit:{},submitBack:{},submitError:{}},this._invokeAll=function(){for(var e=0;e<engine.requests.length;e++){engine.requests[e].invoke()}0===engine.requests.length&&engine.completeCB()},this.complete=function(e){engine.completeCB=function(){engine._initForms(),e&&e()},engine._invokeAll()},this.onBeforeRender=function(e,t){engine.events.beforeRender[e]=t},this.onAfterRender=function(e,t){engine.events.afterRender[e]=t},this.onBeforeInvoke=function(e,t){engine.events.beforeInvoke[e]=t},this.onAfterInvoke=function(e,t){engine.events.afterInvoke[e]=t},this.onInvokeError=function(e,t){engine.events.invokeError[e]=t},this.onBeforeSubmit=function(e,t){engine.events.beforeSubmit[e]=t},this.onSubmitBack=function(e,t){engine.events.submitBack[e]=t},this.onSubmitError=function(e,t){engine.events.submitError[e]=t},this._init=function(){$("script[type='text/template7']").each(function(e){var t=new Template(this);engine.templates[t.id]=t}),$("["+ATTR_URL+"]").each(function(){var e=new Request(this);engine.requests.push(e)})},this._initForms=function(){$("[data-ajax-form]").each(function(){var e=new Form(this);engine.forms[e.id]=e})},this._init()}var e7=new Engine7;return e7}();
//# sourceMappingURL=engine7.min.js.map
