/**
 * engine7 
 * 
 * 
 * https://github.com/jindong5210/engine7
 * 
 * Copyright 2017, Jeffrey King
 * 
 * Licensed under MIT
 * 
 * Released on: March 28, 2017
 */
window.Engine7=function(){"use strict";function isNull(e){return null===e||""===e||void 0===e}function encodeJSON(e){for(var n in e)e[n]=encodeURIComponent(e[n]);return e}function Engine7(){function Request(element){var req=this;this.id=null,this.url=null,this.params=null,this.method="GET",this.tpl=null,this.dom=null,this.context={},this.handleSuccess=function(e,n){if(!isNull(req.id)){var t=engine.events.afterInvoke[req.id];isNull(t)||t(e,n,req)}e.$context=req.context,isNull(req.tpl)||req.tpl.render(e,req.dom)},this.handleError=function(e,n,t){if(isNull(req.id)||isNull(engine.events.error[req.id]))throw console.error(t),new Error("Error occurs when invoking request ["+req.url+"]");var r=engine.events.error[req.id];isNull(r)||r(e,n,t,req)},this.invoke=function(){var urlTemplate=Template7.compile(req.url),url=urlTemplate(req.context),params={};if(!isNull(req.params)){var paramsTemplate=Template7.compile(req.params);params=paramsTemplate(req.context);try{params=eval("("+params+")")}catch(e){throw console.error(e),new Error("Can not parse params to JSON. ["+req.id+"].")}"GET"==req.method&&(params=encodeJSON(params))}var options={url:url,type:req.method,dataType:"json",data:params,success:req.handleSuccess,error:req.handleError};if(!isNull(req.id)){var beforeInvokeEventCB=engine.events.beforeInvoke[req.id];isNull(beforeInvokeEventCB)||beforeInvokeEventCB(options,req)}$.ajax(options).done(function(){engine.tasks--}),engine.tasks++},this.init=function(){var e=$(element).attr(ATTR_TPL_ID),n=$(element).attr(ATTR_METHOD),t=$(element).attr(ATTR_ID);if(!isNull(e)){if(req.tpl=engine.templates[e],isNull(req.tpl))throw new Error("Undefined template ["+e+"].");$(element).attr(ATTR_REF,e)}isNull(n)||(req.method=n),isNull(t)||(req.id=t),req.url=$(element).attr(ATTR_URL),req.params=$(element).attr(ATTR_PARAMS),req.dom=$(element)},this.init()}function Template(e){var n=this;this.id=null,this.src=null,this.render=function(e,t){var r=Template7.compile(n.src),i=engine.events.beforeRender[n.id];isNull(i)||i(e,n);var s=r(e),o=$(s);t.append(o);var l=engine.events.afterRender[n.id];isNull(l)||l(o,n);var a=o.filter("["+ATTR_URL+"]");a.each(function(){var n=new Request(this);n.context=e,n.invoke()}),1===engine.tasks&&0===a.length&&engine.complete()},this.init=function(){if(n.id=$(e).attr("id"),n.src=$(e).html(),isNull(n.id))throw new Error("ID is undefined in template.")},this.init()}var engine=this,ATTR_TEMPLATE7="text/template7",ATTR_ID="id",ATTR_TPL_ID="data-tpl-id",ATTR_URL="data-api-url",ATTR_METHOD="data-api-method",ATTR_PARAMS="data-api-param",ATTR_REF="data-tpl-ref";this.requests=[],this.templates={},this.tasks=0,this.complete=null,this.events={beforeInvoke:{},afterInvoke:{},beforeRender:{},afterRender:{},error:{}},this.invokeAll=function(){for(var e=0;e<engine.requests.length;e++){engine.requests[e].invoke()}},this.complete=function(e){engine.invokeAll(),engine.complete=e},this.onBeforeRender=function(e,n){engine.events.beforeRender[e]=n},this.onAfterRender=function(e,n){engine.events.afterRender[e]=n},this.onBeforeInvoke=function(e,n){engine.events.beforeInvoke[e]=n},this.onAfterInvoke=function(e,n){engine.events.afterInvoke[e]=n},this.onError=function(e,n){engine.events.error[e]=n},this._init=function(){$("script[type='text/template7']").each(function(e){var n=new Template(this);engine.templates[n.id]=n}),$("["+ATTR_URL+"]").each(function(){var e=new Request(this);engine.requests.push(e)})},this._init()}var e7=new Engine7;return e7}();
//# sourceMappingURL=engine7.min.js.map
