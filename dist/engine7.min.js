/**
 * engine7 
 * 
 * 
 * https://github.com/jindong5210/engine7
 * 
 * Copyright 2017, Jeffrey King
 * 
 * Licensed under MIT
 * 
 * Released on: May 9, 2017
 */
window.Engine7=function(){"use strict";function isNull(e){return null===e||""===e||void 0===e}function getArrayIndex(e,n){for(var t=0;t<e.length;t++)if(e[t]==n)return t;return-1}function encodeJSON(e){for(var n in e)e[n]=encodeURIComponent(e[n]);return e}function randomString(e){e=e||8;for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=n.length,r="",i=0;i<e;i++)r+=n.charAt(Math.floor(Math.random()*t));return r}function Engine7(){function Request(element){var req=this;this.id=null,this.url=null,this.params=null,this.method="GET",this.tpl=null,this.dom=null,this.context={},this.onBeforeInvoke=null,this.onAfterInvoke=null,this.onInvokeError=null,this.handleSuccess=function(e,n){isNull(req.onAfterInvoke)||req.onAfterInvoke(e,n,req),e.$context=req.context,isNull(req.tpl)||req.tpl.render(e,req.dom)},this.handleError=function(e,n,t){if(isNull(req.onInvokeError))throw console.error(t),new Error("Error occurs when invoking request ["+req.url+"]");req.onInvokeError(e,n,t,req)},this.invoke=function(){var urlTemplate=Template7.compile(req.url),url=urlTemplate(req.context),params={};if(!isNull(req.params)){var paramsTemplate=Template7.compile(req.params);params=paramsTemplate(req.context);try{params=eval("("+params+")")}catch(e){throw console.error(e),new Error("Can not parse params to JSON. ["+req.url+"].")}"GET"==req.method&&(params=encodeJSON(params))}var options={url:url,type:req.method,dataType:"json",data:params,success:req.handleSuccess,error:req.handleError};isNull(req.onBeforeInvoke)||req.onBeforeInvoke(options,req),$.ajax(options).done(function(){engine.tasks--}),engine.tasks++},this.init=function(){var e=$(element).attr(ATTR_TPL_ID),n=$(element).attr(ATTR_METHOD),t=$(element).attr(ATTR_ID);if(!isNull(e)){if(req.tpl=engine.templates[e],isNull(req.tpl))throw new Error("Undefined template ["+e+"].");$(element).attr(ATTR_REF,e)}isNull(n)||(req.method=n),isNull(t)&&(req.id="req-"+randomString()),req.url=$(element).attr(ATTR_URL),req.params=$(element).attr(ATTR_PARAMS),req.dom=$(element);var r=engine.events.beforeInvoke["*"]?"*":req.id;req.onBeforeInvoke=engine.events.beforeInvoke[r],r=engine.events.afterInvoke["*"]?"*":req.id,req.onAfterInvoke=engine.events.afterInvoke[r],r=engine.events.invokeError["*"]?"*":req.id,req.onInvokeError=engine.events.invokeError[r]},this.init()}function Template(e){var n=this;this.id=null,this.src=null,this.onBeforeRender=null,this.onAfterRender=null,this.render=function(e,t){var r=Template7.compile(n.src);isNull(n.onBeforeRender)||n.onBeforeRender(e,n);var i=r(e),o=$(i);t.append(o),isNull(n.onAfterRender)||n.onAfterRender(o,n);var s=o.filter("["+ATTR_URL+"]");s.each(function(){var n=new Request(this);n.context=e,n.invoke(),engine.requests[n.id]=n}),1===engine.tasks&&0===s.length&&engine.completeCB()},this.init=function(){if(n.id=$(e).attr("id"),n.src=$(e).html(),isNull(n.id))throw new Error("ID is required on template.");var t=engine.events.beforeRender["*"]?"*":n.id;n.onBeforeRender=engine.events.beforeRender[t],t=engine.events.afterRender["*"]?"*":n.id,n.onAfterRender=engine.events.afterRender[t]},this.init()}function Form(e){var n=this;this.id=null,this.el=null,this.action=null,this.method="GET",this.onBeforeSubmit=null,this.onSubmitBack=null,this.onSubmitError=null,this.putElJSON=function(e,n,t){for(var r=n.split(/\./);r.length>1;){var i=r.shift();e[i]||(e[i]={}),e=e[i]}var o=r[r.length-1];if(void 0!==e[o]){var s=e[o];Array.isArray(e[o])||(s=[e[o]]),s.push(t),e[o]=s}else e[o]=t},this.toJSON=function(){var t={};return $(e).find("input,textarea,select").each(function(){var e=this.tagName,r=$(this).attr("type"),i=$(this).attr("name"),o=$(this).val();return!i||("INPUT"===e&&("button"===r||"submit"===r)||"reset"===r||(!("INPUT"!==e||"checkbox"!==r&&"radio"!==r||$(this).is(":checked"))||void n.putElJSON(t,i,o)))}),t},this.handleSuccess=function(e,t){isNull(n.onSubmitBack)||n.onSubmitBack(e,t,n)},this.handleError=function(e,t,r){if(isNull(n.onSubmitError))throw console.error(r),new Error("Error occurs when submit form ["+n.id+"]");n.onSubmitError(e,t,r,n)},this.submit=function(){var t=n.toJSON();isNull(n.onBeforeSubmit)||n.onBeforeSubmit(t,n);var r={url:n.action,type:n.method,dataType:"json",data:t,success:n.handleSuccess,error:n.handleError};$.ajax(r).always(function(){$(e).find("[type='submit']").removeAttr("disabled")})},this.init=function(){if(n.id=$(e).attr("id"),n.action=$(e).attr("action"),n.el=e,isNull(n.id)&&(n.id="form-"+randomString()),isNull(n.action))throw new Error("Action is required on data-ajax-form.");var t=$(e).attr("method");isNull(t)||(n.method=t),$(e).submit(function(){return $(e).find("[type='submit']").attr("disabled","disabled"),n.submit(),!1});var r=engine.events.beforeSubmit[n.id]?n.id:"*";n.onBeforeSubmit=engine.events.beforeSubmit[r],r=engine.events.submitBack[n.id]?n.id:"*",n.onSubmitBack=engine.events.submitBack[r],r=engine.events.submitError[n.id]?n.id:"*",n.onSubmitError=engine.events.submitError[r]},this.init()}var engine=this,ATTR_TEMPLATE7="text/template7",ATTR_ID="id",ATTR_TPL_ID="data-tpl-id",ATTR_URL="data-api-url",ATTR_METHOD="data-api-method",ATTR_PARAMS="data-api-param",ATTR_REF="data-tpl-ref",ATTR_AJAX_FORM="data-ajax-form";this.requests={},this.templates={},this.forms={},this.tasks=0,this.completeCB=null,this.events={beforeInvoke:{},afterInvoke:{},beforeRender:{},afterRender:{},invokeError:{},beforeSubmit:{},submitBack:{},submitError:{}},this._invokeAll=function(){var e=0;for(var n in engine.requests){engine.requests[n].invoke(),e++}0===e&&engine.completeCB()},this.complete=function(e){engine._init(),engine.completeCB=function(){engine._initForms(),e&&e()},engine._invokeAll()},this.onBeforeRender=function(e,n){engine.events.beforeRender[e]=n},this.onAfterRender=function(e,n){engine.events.afterRender[e]=n},this.onBeforeInvoke=function(e,n){engine.events.beforeInvoke[e]=n},this.onAfterInvoke=function(e,n){engine.events.afterInvoke[e]=n},this.onInvokeError=function(e,n){engine.events.invokeError[e]=n},this.onBeforeSubmit=function(e,n){engine.events.beforeSubmit[e]=n},this.onSubmitBack=function(e,n){engine.events.submitBack[e]=n},this.onSubmitError=function(e,n){engine.events.submitError[e]=n},this._init=function(){$("script[type='text/template7']").each(function(){var e=new Template(this);engine.templates[e.id]=e}),$("["+ATTR_URL+"]").each(function(){var e=new Request(this);engine.requests[e.id]=e})},this._initForms=function(){$("[data-ajax-form]").each(function(){var e=new Form(this);engine.forms[e.id]=e})}}var e7=new Engine7;return e7}();
//# sourceMappingURL=engine7.min.js.map
